<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>My BCIT Project</title>
    <meta name="comp1800 boilerplate code" content="my bcit project">
    <meta name="author" content="BCIT">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap, firebase-auth-ui -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.css" />
    <!-- <script src="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.js%22%3E"> </script> -->
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.css" />


    <!--database stuff goes here -->
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>


    <!-- Optional styles and scripts of your own -->
    <link type=" text/css" href="styles/my_style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">


    <!--Mapbox Stuff-->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js"></script>

    <style>
        #map {
            position: absolute;
            margin-left: auto;
            margin-right: auto;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            width: 90%;
            height: auto;
            border-radius: 3.5em;
        }
    </style>

</head>

<body>

    <!-------------------------------------->
    <!-- The following is HTML for layout -->
    <!-------------------------------------->
    <!-- Header Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-info m-3">
        <div class="container-fluid d-flex justify-content-lg-evenly">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <a class="navbar-brand" href="#">Communiti</a>
            <span id="name"></span>

            <i class="material-icons">person_outline</i>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">About Us</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.html">Login/Signup</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Contact Us</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- welcome and main part of the page -->
    <div class="container" id="searchbar">
        <section class="w-100 p-4 pb-4 d-flex justify-content-center align-items-center flex-column">
            <!-- <div>
                <div class="input-group rounded">
                    <input type="search" class="form-control rounded" placeholder="Search" aria-label="Search"
                        aria-describedby="search-addon">
                    <span class="input-group-text border-0" id="search-addon">
                        <a href=""><i class="material-icons">search</i></a>
                    </span>
                    <button class="input-group-text border-0" id="search-addon" type="submit">
                        <i class="material-icons">search</i>
                    </button>
                </div>
            </div> -->
        </section>

        <!-------------------------------------->
        <!-- Add map thing here -->

        <div class="map-container">
            <div id="map"
                style="border: 1px solid white; display: flex; margin-top: 13em; margin-bottom: 8em; height: 40%;">
            </div>
        </div>

        <div id="volunteering-listing" style="margin-top: 26em; overflow: auto; height: 300px; border: 1px solid black">

        </div>

        <!-------------------------------------->

        <!-- these are the debugging buttons for some of the js functions  -->
        <!-- <div style="display: grid; grid-template-columns: 100%; width: 10%">
            <button id="retrieve-from-db">
                click to retrieve from database
            </button>
            <button id="populate-to-map">
                click to populate onto map
            </button>
        </div> -->

        <!-- search debugging bar -->
        <!-- <div>
            <form>
                <label for="location-search">Enter search query</label>
                <input type="text" id="location-search" name="location-search">
                <input type="submit" value="Search">
            </form>
        </div> -->

    </div>

    <!-- Footer Navigation Bar -->
    <footer class="navbar fixed-bottom py-3 bg-info m-3 rounded">
        <div class="container d-flex justify-content-around">
            <a href="main.html"><i class="material-icons">home</i></a>
            <a href="./html/saved.html"><i class="material-icons">star</i></a>
            <a href="./html/request/1_location.html"><i class="material-icons">add_circle</i></a>
            <a href="./html/active.html"><i class="material-icons">map</i></a>
            <i class="material-icons">more_horiz</i>
        </div>
    </footer>


    <!----------------------------------------------->
    <!-- JS: Boostrap, Firebase, API related, add Jquery    -->
    <!----------------------------------------------->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
        </script> -->
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>

    <!-- Link to the api keys for your firebase project -->
    <script src="scripts/firebaseAPI.js"></script>
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css"
        type="text/css">

    <!-- <script src='https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.js'></script> -->

    <!--------------------------------------------------------------------->
    <!-- JS files: Your own JavaScript functions included here    -->

    <script>


        // DON"T DELETE THIS!!! THIS IS THE SEARCH FUNCTIONALITY!!!
        // document.querySelector("form").addEventListener("submit", (e) => {
        //     e.preventDefault();
        //     let test = document.getElementById("location-search").value;

        //     //console.log(test);

        //     // append location text after slash and before question mark
        //     $.ajax({
        //         url: "https://api.mapbox.com/geocoding/v5/mapbox.places/" + test + ".json?access_token=pk.eyJ1Ijoidndnb2xmZ3RpIiwiYSI6ImNrcHJhcHhwOTAyM28ydXBpMWlranpwOGkifQ.JtdxQSekLtejtN-cjEIg_A",
        //         contentType: "application/json",
        //         dataType: 'json',
        //         success: function (result) {
        //             console.log(result);
        //         }
        //     })
        // })


        mapboxgl.accessToken = 'pk.eyJ1Ijoidndnb2xmZ3RpIiwiYSI6ImNrcHJhcHhwOTAyM28ydXBpMWlranpwOGkifQ.JtdxQSekLtejtN-cjEIg_A';
        const map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/mapbox/streets-v11', // style URL
            center: [-123.11, 49.24], // starting position [lng, lat]
            zoom: 10 // starting zoom
        });

        map.addControl(
            new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                mapboxgl: mapboxgl
            })
        );

        // const marker = new mapboxgl.Marker({
        //     draggable: true
        // }).setLngLat([-123.1, 49.21])
        //     .addTo(map);

        // const marker1 = new mapboxgl.Marker()
        //     .setLngLat([-123.11, 49.23])
        //     .addTo(map);


        map.on('style.load', function () {
            map.on('click', function (e) {
                var coordinates = e.lngLat;
                console.log(coordinates);
                //popUpBox();
                new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    // .setHTML('there is a volunteering opportunity here <br>' + coordinates)
                    .addTo(map);
            });
        });

        // popUpBox = () => {
        //     console.log("is this working");

        // }

        // 
        // const btn = document.querySelectorAll("button");
        // btn.forEach((b) => {
        //     b.addEventListener("click", (e) => {
        //         if (e.target.id === "retrieve-from-db") {
        //             dataBaseFunction();
        //             getCoordinate();
        //         }

        //         if (e.target.id === "populate-to-map") {
        //             populateMap();
        //         }
        //     })
        // })

        let tempCoorStorage = [];


        // storeCoordinate = () => {
        //     let test;
        //     db.collection("pins").get()
        //         .then(users => {
        //             users.forEach(u => {
        //                 console.log(u.data());
        //                 //populateMap();
        //                 tempCoorStorage.push(u.data());
        //             })

        //         })

        //     console.log(tempCoorStorage);
        // }

        // update pins on map
        //NOTE: MIGHT NOT BE NEEDED ANYMORE, POSSIBLY DELETE?
/*         function updatePins() {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    //console.log(user.uid);
                    currentUser = db.collection("users").doc(user.uid).collection("volunteering_saved");
                    currentUser
                        .get()
                        .then(a => {
                            a.forEach(d => {
                                //console.log(d.data().address);
                                //tempCoorStorage.push(d.data());
                                new mapboxgl.Marker()
                                    .setLngLat([d.data().lng, d.data().lat])
                                    .addTo(map);
                            })
                        })
                }
            })
            //console.log(tempCoorStorage);
        }
        updatePins(); */

        // this function retrieves from db
        // dataBaseFunction = () => {
        //     db.collection("users").doc(user.uid).get()
        //         .then(users => {
        //             users.forEach(u => {
        //                 console.log(u.data());
        //             })
        //         })

        // }
        // dataBaseFunction();

        // flow: first retrieve from db -> drop map pins


        // this populates pins onto map
        populateMap = () => {
            //console.log(tempCoorStorage);
            // new mapboxgl.Marker()
            //     .setLngLat([tempCoorStorage[0].lng, tempCoorStorage[0].lat])
            //     .addTo(map);
            // for (let i = 0; i < tempCoorStorage.length; i++) {
            //     console.log(tempCoorStorage[i].lng);
            //     console.log(tempCoorStorage[i].lat);

            //     // new mapboxgl.Marker()
            //     //     .setLngLat([tempCoorStorage[i].lng, tempCoorStorage[i].lat])
            //     //     .addTo(map);
            // }
        }
        //populateMap();

        // get data from firebase regardless of user id
        function getAllData() {
            //console.log("Init alldata");
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    //console.log(user.uid);
                    currentUser = db.collection("all_volunteering").doc("all_details").collection("volunteering_saved");
                    //console.log(currentUser);
                     currentUser
                         .get()
                         .then(a => {
                             a.forEach(d => {
                                 //console.log(d.data());
                                 //tempCoorStorage.push(d.data());
                                  new mapboxgl.Marker()
                                      .setLngLat([d.data().lng, d.data().lat])
                                      .addTo(map);
                                 //locationList(d.data());
                                 //flyToLocation(d.data());
                             })
                         })
                }

            })
            //console.log(tempCoorStorage);
        }
        getAllData();

        // get data from firebase
        function getData() {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    //console.log(user.uid);
                    currentUser = db.collection("all_volunteering").doc("all_details").collection("volunteering_saved");
                    currentUser
                        .get()
                        .then(a => {
                            a.forEach(d => {
                                //console.log(d.data());
                                //tempCoorStorage.push(d.data());
                                // new mapboxgl.Marker()
                                //     .setLngLat([d.data().lng, d.data().lat])
                                //     .addTo(map);
                                locationList(d.data());
                                //flyToLocation(d.data());
                            })
                        })
                }

                if (user) {
                    //console.log(user.uid);
                    currentUser = db.collection("users").doc(user.uid);
                    currentUser
                        .get()
                        .then(a => {
                            console.log(a.data());
                        })
                }
            })
            //console.log(tempCoorStorage);
        }
        getData();


        function locationList(data) {
            // address, category, description, number_volunteers
            //console.log(data);

            const listings = document.getElementById('volunteering-listing');
            const listing = listings.appendChild(document.createElement('div'));
            /* Assign a unique `id` to the listing. */
            //listing.id = `listing-${store.properties.id}`;
            /* Assign the `item` class to each listing for styling. */
            listing.className = 'item';
            listing.style = "border: 1px solid black; margin: 1em"

            /* Add the link to the individual listing created above. */
            const link = listing.appendChild(document.createElement('a'));
            link.href = '#';
            link.className = 'title';
            //link.id = `link-${store.properties.id}`;
            link.innerHTML = `${data.address}`;

            /* Add details to the individual listing. */
            const details = listing.appendChild(document.createElement('div'));
            // const volCategory = data.category;
            // const volDescript = data.description;
            // const numVol = data.number_volunteers;

            //const volContainer = document.createElement("div");
            //volContainer.innerText = volCategory;

            //listing.appendChild(volCategory);
            details.innerHTML = `Description: ${data.description}`;
            details.innerHTML += `<br>`;
            details.innerHTML += `Category: ${data.category}`;
            details.innerHTML += `<br>`;
            details.innerHTML += `Volunteers Needed: ${data.number_volunteers}`;

            link.addEventListener('click', function () {

                // for (const feature of stores.features) {
                //     if (this.id === `link-${feature.properties.id}`) {
                flyToLocation(data);
                createPopUp(data);
                //     }
                // }
                // const activeItem = document.getElementsByClassName('active');
                // if (activeItem[0]) {
                //     activeItem[0].classList.remove('active');
                // }
                // this.parentNode.classList.add('active');
            });

        }

        // structure of coordinates
        //"coordinates": [
        //  -77.049766,
        //  38.900772
        // ]
        function flyToLocation(data) {
            //console.log({data});
            let tempArr = [];
            tempArr.push(data.lng);
            tempArr.push(data.lat);
            map.flyTo({
                center: tempArr,
                zoom: 15
            });
        }

        function createPopUp(data) {
            const popUps = document.getElementsByClassName('mapboxgl-popup');
            /** Check if there is already a popup on the map and if so, remove it */
            if (popUps[0]) popUps[0].remove();

            const popup = new mapboxgl.Popup({ closeOnClick: false })
                .setLngLat([data.lng, data.lat])
                .setHTML(`User profile goes here`)
                .addTo(map);
        }

        function insertName() {
            firebase.auth().onAuthStateChanged(user => {
                // Check if user is signed in:
                if (user) {
                    // Do something for the current logged-in user here: 
                    //console.log(user.uid);
                    //go to the correct user document by referencing to the user uid
                    currentUser = db.collection("users").doc(user.uid);
                    //get the document for current user.
                    currentUser.get()
                        .then(userDoc => {
                            var user_Name = userDoc.data().name;
                            //console.log(user_Name);
                            //method #1:  insert with html only
                            //document.getElementById("name-goes-here").innerText = n;    //using javascript
                            //method #2:  insert using jquery
                            $("#name").text(user_Name);                         //using jquery
                        })
                } else {
                    // No user is signed in.
                }
            });
        }

        insertName();


    </script>

    <!--------------------------------------------------------------------->

</body>

</html>